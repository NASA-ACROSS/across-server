"""create TESS

Revision ID: 2b00546497c1
Revises: 818523f50d93
Create Date: 2025-02-13 14:43:06.464266

"""

from __future__ import annotations

from typing import List, Sequence, Union
from uuid import uuid4

from alembic import op
from sqlalchemy import orm

from migrations.versions.model_snapshots.models_2025_02_13 import (
    ACROSSFootprintPoint,
    Footprint,
    Group,
    Instrument,
    Observation,
    Observatory,
    Schedule,
    Telescope,
    create_geography,
    group_observatory,
)

# revision identifiers, used by Alembic.
revision: str = "2b00546497c1"
down_revision: Union[str, None] = "818523f50d93"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

footprint = [
    [
        {"x": 0.48375, "y": -35.68681},
        {"x": 3.4458, "y": -35.63416},
        {"x": 6.38082, "y": -35.51055},
        {"x": 9.26671, "y": -35.31935},
        {"x": 12.08269, "y": -35.06575},
        {"x": 14.80865, "y": -34.7567},
        {"x": 14.38083, "y": -32.45728},
        {"x": 13.96412, "y": -30.17389},
        {"x": 13.55777, "y": -27.92068},
        {"x": 13.16059, "y": -25.71209},
        {"x": 12.77126, "y": -23.5627},
        {"x": 10.39758, "y": -23.68798},
        {"x": 7.95668, "y": -23.79461},
        {"x": 5.46455, "y": -23.87755},
        {"x": 2.93743, "y": -23.93291},
        {"x": 0.39157, "y": -23.95824},
        {"x": 0.40843, "y": -26.21478},
        {"x": 0.42602, "y": -28.52986},
        {"x": 0.44441, "y": -30.88942},
        {"x": 0.46364, "y": -33.27976},
        {"x": 0.48375, "y": -35.68681},
    ],
    [
        {"x": -14.70493, "y": -34.8308},
        {"x": -11.97562, "y": -35.12823},
        {"x": -9.15672, "y": -35.36972},
        {"x": -6.26852, "y": -35.54841},
        {"x": -3.33187, "y": -35.65924},
        {"x": -0.36895, "y": -35.69891},
        {"x": -0.36436, "y": -33.29178},
        {"x": -0.35969, "y": -30.90129},
        {"x": -0.35496, "y": -28.54153},
        {"x": -0.35017, "y": -26.22619},
        {"x": -0.34527, "y": -23.96934},
        {"x": -2.89161, "y": -23.95547},
        {"x": -5.41943, "y": -23.91145},
        {"x": -7.91245, "y": -23.83963},
        {"x": -10.3544, "y": -23.74384},
        {"x": -12.72921, "y": -23.62903},
        {"x": -13.10767, "y": -25.78002},
        {"x": -13.49326, "y": -27.99018},
        {"x": -13.8873, "y": -30.24495},
        {"x": -14.29095, "y": -32.52987},
        {"x": -14.70493, "y": -34.8308},
    ],
    [
        {"x": -17.03128, "y": -46.62409},
        {"x": -13.92527, "y": -47.10878},
        {"x": -10.67781, "y": -47.50214},
        {"x": -7.31929, "y": -47.79387},
        {"x": -3.88334, "y": -47.97631},
        {"x": -0.40577, "y": -48.04453},
        {"x": -0.40023, "y": -45.78678},
        {"x": -0.39445, "y": -43.47074},
        {"x": -0.38857, "y": -41.11047},
        {"x": -0.38263, "y": -38.71966},
        {"x": -0.37664, "y": -36.3124},
        {"x": -3.36259, "y": -36.27015},
        {"x": -6.32159, "y": -36.15464},
        {"x": -9.23104, "y": -35.96925},
        {"x": -12.06969, "y": -35.71922},
        {"x": -14.81695, "y": -35.41152},
        {"x": -15.24534, "y": -37.71256},
        {"x": -15.68343, "y": -39.99825},
        {"x": -16.12941, "y": -42.25471},
        {"x": -16.58017, "y": -44.46798},
        {"x": -17.03128, "y": -46.62409},
    ],
    [
        {"x": 0.60531, "y": -48.04468},
        {"x": 4.08187, "y": -47.96217},
        {"x": 7.51513, "y": -47.76566},
        {"x": 10.86945, "y": -47.46022},
        {"x": 14.11145, "y": -47.05369},
        {"x": 17.21103, "y": -46.55648},
        {"x": 16.74218, "y": -44.40193},
        {"x": 16.27452, "y": -42.19018},
        {"x": 15.81247, "y": -39.93521},
        {"x": 15.35916, "y": -37.65095},
        {"x": 14.91634, "y": -35.35128},
        {"x": 12.17177, "y": -35.67049},
        {"x": 9.33539, "y": -35.93246},
        {"x": 6.42764, "y": -36.13011},
        {"x": 3.4697, "y": -36.25812},
        {"x": 0.48413, "y": -36.313},
        {"x": 0.50633, "y": -38.7202},
        {"x": 0.52954, "y": -41.11094},
        {"x": 0.55378, "y": -43.47111},
        {"x": 0.57907, "y": -45.78705},
        {"x": 0.60531, "y": -48.04468},
    ],
    [
        {"x": 0.34208, "y": -11.72273},
        {"x": 2.79962, "y": -11.71446},
        {"x": 5.23966, "y": -11.68577},
        {"x": 7.64735, "y": -11.63749},
        {"x": 10.00829, "y": -11.571},
        {"x": 12.30801, "y": -11.48812},
        {"x": 12.20126, "y": -9.1646},
        {"x": 12.08523, "y": -6.85719},
        {"x": 11.95967, "y": -4.58},
        {"x": 11.82372, "y": -2.34743},
        {"x": 11.6758, "y": -0.17465},
        {"x": 9.50003, "y": -0.11237},
        {"x": 7.26451, "y": -0.06461},
        {"x": 4.98436, "y": -0.02961},
        {"x": 2.67398, "y": -0.00629},
        {"x": 0.34743, "y": 0.0059},
        {"x": 0.34712, "y": -2.25101},
        {"x": 0.3464, "y": -4.56625},
        {"x": 0.34531, "y": -6.92591},
        {"x": 0.34387, "y": -9.31614},
        {"x": 0.34208, "y": -11.72273},
    ],
    [
        {"x": -12.33872, "y": -11.42469},
        {"x": -10.03863, "y": -11.51729},
        {"x": -7.67747, "y": -11.59385},
        {"x": -5.26964, "y": -11.65244},
        {"x": -2.82956, "y": -11.69164},
        {"x": -0.37207, "y": -11.71055},
        {"x": -0.36311, "y": -9.304},
        {"x": -0.35404, "y": -6.91387},
        {"x": -0.34491, "y": -4.55437},
        {"x": -0.3357, "y": -2.23936},
        {"x": -0.32641, "y": 0.01725},
        {"x": -2.65302, "y": 0.01568},
        {"x": -4.96378, "y": 0.00287},
        {"x": -7.2446, "y": -0.0218},
        {"x": -9.48112, "y": -0.05948},
        {"x": -11.65823, "y": -0.112},
        {"x": -11.8152, "y": -2.28442},
        {"x": -11.96053, "y": -4.51673},
        {"x": -12.09578, "y": -6.79377},
        {"x": -12.22176, "y": -9.10112},
        {"x": -12.33872, "y": -11.42469},
    ],
    [
        {"x": -12.7711, "y": -23.36217},
        {"x": -10.41145, "y": -23.60256},
        {"x": -7.978, "y": -23.79588},
        {"x": -5.48896, "y": -23.93981},
        {"x": -2.96208, "y": -24.03245},
        {"x": -0.41492, "y": -24.07246},
        {"x": -0.40674, "y": -21.81651},
        {"x": -0.39824, "y": -19.50202},
        {"x": -0.38951, "y": -17.14291},
        {"x": -0.3806, "y": -14.75303},
        {"x": -0.37153, "y": -12.34657},
        {"x": -2.83483, "y": -12.32631},
        {"x": -5.28061, "y": -12.28406},
        {"x": -7.69395, "y": -12.22078},
        {"x": -10.06036, "y": -12.13798},
        {"x": -12.36535, "y": -12.03761},
        {"x": -12.47071, "y": -14.36171},
        {"x": -12.56581, "y": -16.67041},
        {"x": -12.64923, "y": -18.9497},
        {"x": -12.71875, "y": -21.18528},
        {"x": -12.7711, "y": -23.36217},
    ],
    [
        {"x": 0.31703, "y": -24.07514},
        {"x": 2.86436, "y": -24.04703},
        {"x": 5.39167, "y": -23.96617},
        {"x": 7.88134, "y": -23.83381},
        {"x": 10.3156, "y": -23.65174},
        {"x": 12.67616, "y": -23.42218},
        {"x": 12.63631, "y": -21.24566},
        {"x": 12.57915, "y": -19.01035},
        {"x": 12.50793, "y": -16.73125},
        {"x": 12.42484, "y": -14.42268},
        {"x": 12.33126, "y": -12.09866},
        {"x": 10.02654, "y": -12.18793},
        {"x": 7.6603, "y": -12.25927},
        {"x": 5.24707, "y": -12.3108},
        {"x": 2.80135, "y": -12.34113},
        {"x": 0.33808, "y": -12.34935},
        {"x": 0.33466, "y": -14.75581},
        {"x": 0.33085, "y": -17.14568},
        {"x": 0.32667, "y": -19.50477},
        {"x": 0.32207, "y": -21.81923},
        {"x": 0.31703, "y": -24.07514},
    ],
    [
        {"x": -11.65066, "y": 0.12289},
        {"x": -9.47403, "y": 0.07175},
        {"x": -7.2378, "y": 0.03548},
        {"x": -4.95712, "y": 0.0122},
        {"x": -2.64635, "y": 0.00076},
        {"x": -0.31957, "y": 0.00054},
        {"x": -0.33055, "y": 2.25779},
        {"x": -0.34147, "y": 4.57338},
        {"x": -0.35234, "y": 6.93331},
        {"x": -0.36315, "y": 9.3236},
        {"x": -0.37387, "y": 11.73001},
        {"x": -2.83118, "y": 11.70933},
        {"x": -5.27103, "y": 11.66832},
        {"x": -7.67854, "y": 11.60789},
        {"x": -10.03918, "y": 11.52951},
        {"x": -12.33844, "y": 11.4351},
        {"x": -12.22004, "y": 9.11193},
        {"x": -12.09259, "y": 6.80483},
        {"x": -11.95588, "y": 4.52787},
        {"x": -11.80909, "y": 2.2955},
        {"x": -11.65066, "y": 0.12289},
    ],
    [
        {"x": 0.342, "y": -0.00098},
        {"x": 2.66878, "y": 0.01312},
        {"x": 4.97961, "y": 0.03832},
        {"x": 7.26042, "y": 0.07513},
        {"x": 9.49685, "y": 0.12459},
        {"x": 11.67375, "y": 0.18849},
        {"x": 11.81912, "y": 2.3622},
        {"x": 11.95249, "y": 4.59564},
        {"x": 12.07548, "y": 6.8736},
        {"x": 12.18894, "y": 9.18168},
        {"x": 12.29309, "y": 11.50579},
        {"x": 9.99212, "y": 11.58646},
        {"x": 7.63011, "y": 11.65062},
        {"x": 5.22158, "y": 11.69646},
        {"x": 2.78111, "y": 11.72264},
        {"x": 0.32357, "y": 11.72835},
        {"x": 0.32803, "y": 9.32193},
        {"x": 0.33212, "y": 6.93165},
        {"x": 0.33582, "y": 4.57174},
        {"x": 0.33913, "y": 2.2562},
        {"x": 0.342, "y": -0.00098},
    ],
    [
        {"x": 0.32052, "y": 12.3595},
        {"x": 2.78382, "y": 12.35276},
        {"x": 5.22996, "y": 12.32388},
        {"x": 7.64399, "y": 12.27371},
        {"x": 10.01125, "y": 12.20364},
        {"x": 12.31715, "y": 12.11555},
        {"x": 12.40916, "y": 14.43996},
        {"x": 12.49069, "y": 16.7488},
        {"x": 12.56036, "y": 19.02802},
        {"x": 12.616, "y": 21.26332},
        {"x": 12.65433, "y": 23.43966},
        {"x": 10.29253, "y": 23.66757},
        {"x": 7.85731, "y": 23.84785},
        {"x": 5.367, "y": 23.97833},
        {"x": 2.83938, "y": 24.05722},
        {"x": 0.29206, "y": 24.0833},
        {"x": 0.29854, "y": 21.82806},
        {"x": 0.3046, "y": 19.51403},
        {"x": 0.31027, "y": 17.15524},
        {"x": 0.31558, "y": 14.76565},
        {"x": 0.32052, "y": 12.3595},
    ],
    [
        {"x": -12.36982, "y": 12.02663},
        {"x": -10.066, "y": 12.12832},
        {"x": -7.70043, "y": 12.21251},
        {"x": -5.2877, "y": 12.27722},
        {"x": -2.84243, "y": 12.32094},
        {"x": -0.37956, "y": 12.3427},
        {"x": -0.39015, "y": 14.74887},
        {"x": -0.4006, "y": 17.13858},
        {"x": -0.41085, "y": 19.49759},
        {"x": -0.42085, "y": 21.8119},
        {"x": -0.43049, "y": 24.06753},
        {"x": -2.97717, "y": 24.02557},
        {"x": -5.50329, "y": 23.931},
        {"x": -7.99125, "y": 23.78518},
        {"x": -10.42335, "y": 23.59004},
        {"x": -12.7813, "y": 23.34788},
        {"x": -12.72796, "y": 21.17176},
        {"x": -12.65732, "y": 18.93688},
        {"x": -12.57274, "y": 16.65824},
        {"x": -12.47643, "y": 14.35015},
        {"x": -12.36982, "y": 12.02663},
    ],
    [
        {"x": -12.75285, "y": 23.62748},
        {"x": -10.37793, "y": 23.74922},
        {"x": -7.93548, "y": 23.85249},
        {"x": -5.44202, "y": 23.93172},
        {"x": -2.91379, "y": 23.98301},
        {"x": -0.36702, "y": 24.00397},
        {"x": -0.37894, "y": 26.26186},
        {"x": -0.39126, "y": 28.57767},
        {"x": -0.40403, "y": 30.93748},
        {"x": -0.41728, "y": 33.32745},
        {"x": -0.43102, "y": 35.73341},
        {"x": -3.39328, "y": 35.68597},
        {"x": -6.32908, "y": 35.56738},
        {"x": -9.2162, "y": 35.38096},
        {"x": -12.03362, "y": 35.13187},
        {"x": -14.76127, "y": 34.82698},
        {"x": -14.33995, "y": 32.52757},
        {"x": -13.92941, "y": 30.24363},
        {"x": -13.52896, "y": 27.98923},
        {"x": -13.13737, "y": 25.77881},
        {"x": -12.75285, "y": 23.62748},
    ],
    [
        {"x": 0.36468, "y": 23.99372},
        {"x": 2.91107, "y": 23.97578},
        {"x": 5.43888, "y": 23.92754},
        {"x": 7.9319, "y": 23.85135},
        {"x": 10.37387, "y": 23.75113},
        {"x": 12.74825, "y": 23.63241},
        {"x": 13.13013, "y": 25.78355},
        {"x": 13.51886, "y": 27.99386},
        {"x": 13.91623, "y": 30.24824},
        {"x": 14.32349, "y": 32.53224},
        {"x": 14.74132, "y": 34.83179},
        {"x": 12.01374, "y": 35.13355},
        {"x": 9.19644, "y": 35.37947},
        {"x": 6.30953, "y": 35.56268},
        {"x": 3.37401, "y": 35.67806},
        {"x": 0.41213, "y": 35.7223},
        {"x": 0.40217, "y": 33.31638},
        {"x": 0.39246, "y": 30.92651},
        {"x": 0.38299, "y": 28.56688},
        {"x": 0.37374, "y": 26.2513},
        {"x": 0.36468, "y": 23.99372},
    ],
    [
        {"x": 0.41807, "y": 36.37686},
        {"x": 3.40448, "y": 36.33005},
        {"x": 6.36384, "y": 36.20984},
        {"x": 9.27345, "y": 36.01964},
        {"x": 12.11187, "y": 35.76476},
        {"x": 14.85866, "y": 35.45219},
        {"x": 15.29123, "y": 37.75124},
        {"x": 15.73369, "y": 40.03434},
        {"x": 16.18425, "y": 42.28767},
        {"x": 16.6396, "y": 44.49728},
        {"x": 17.09435, "y": 46.64879},
        {"x": 13.99216, "y": 47.13858},
        {"x": 10.74718, "y": 47.53677},
        {"x": 7.39065, "y": 47.83341},
        {"x": 3.95619, "y": 48.02089},
        {"x": 0.4795, "y": 48.09422},
        {"x": 0.46672, "y": 45.84056},
        {"x": 0.45411, "y": 43.52806},
        {"x": 0.44178, "y": 41.17067},
        {"x": 0.42976, "y": 38.78222},
        {"x": 0.41807, "y": 36.37686},
    ],
    [
        {"x": -14.87486, "y": 35.43941},
        {"x": -12.12807, "y": 35.75424},
        {"x": -9.28969, "y": 36.01142},
        {"x": -6.38012, "y": 36.20396},
        {"x": -3.4208, "y": 36.32654},
        {"x": -0.43443, "y": 36.37574},
        {"x": -0.44921, "y": 38.78111},
        {"x": -0.46454, "y": 41.16956},
        {"x": -0.48041, "y": 43.52695},
        {"x": -0.4968, "y": 45.83947},
        {"x": -0.51363, "y": 48.09314},
        {"x": -3.99019, "y": 48.01731},
        {"x": -7.42437, "y": 47.82737},
        {"x": -10.78051, "y": 47.5283},
        {"x": -14.02502, "y": 47.12776},
        {"x": -17.12674, "y": 46.63569},
        {"x": -16.66832, "y": 44.48425},
        {"x": -16.20953, "y": 42.27471},
        {"x": -15.75576, "y": 40.02145},
        {"x": -15.31027, "y": 37.73841},
        {"x": -14.87486, "y": 35.43941},
    ],
]


OBSERVATORY = {
    "name": "Transiting Exoplanet Survey Satellite",
    "short_name": "TESS",
    "observatory_type": "SPACE_BASED",
    "telescopes": [
        {
            "name": "Transiting Exoplanet Survey Satellite",
            "short_name": "TESS",
            "instruments": [
                {
                    "name": "Transiting Exoplanet Survey Satellite",
                    "short_name": "TESS",
                    "footprint": footprint,
                }
            ],
        }
    ],
}


def upgrade() -> None:
    bind = op.get_bind()
    session = orm.Session(bind=bind, expire_on_commit=False)

    # create group based off the observatory
    group = Group(
        id=uuid4(), name=OBSERVATORY["name"], short_name=OBSERVATORY["short_name"]
    )
    session.add(group)

    # # create observatory
    observatory_insert = Observatory(
        id=uuid4(),
        name=OBSERVATORY["name"],
        short_name=OBSERVATORY["short_name"],
        observatory_type=OBSERVATORY["observatory_type"],
        group=group,
    )
    session.add(observatory_insert)
    observatory_id = observatory_insert.id

    # get the telescopes
    telescopes = OBSERVATORY["telescopes"]
    for telescope in telescopes:
        # create the telescope record
        telescope_insert = Telescope(
            id=uuid4(),
            name=telescope["name"],  #  type:ignore
            short_name=telescope["short_name"],  #  type:ignore
            observatory_id=observatory_id,
        )
        session.add(telescope_insert)
        telescope_id = telescope_insert.id

        # get the instruments
        instruments = telescope["instruments"]  #  type:ignore
        for instrument in instruments:
            # create the instrument record
            instrument_insert = Instrument(
                id=uuid4(),
                name=instrument["name"],  #  type:ignore
                short_name=instrument["short_name"],  #  type:ignore
                telescope_id=telescope_id,
            )
            session.add(instrument_insert)
            instrument_id = instrument_insert.id

            footprints = instrument["footprint"]
            for footprint in footprints:
                # convert the input footprint to the string polygon
                vertices = []
                for point in footprint:
                    vertices.append(ACROSSFootprintPoint(x=point["x"], y=point["y"]))

                polygon = create_geography(polygon=vertices)

                # create the footprint model record
                footprint_insert = Footprint(
                    polygon=polygon, instrument_id=instrument_id
                )
                session.add(footprint_insert)

    session.commit()


def downgrade() -> None:
    bind = op.get_bind()
    session = orm.Session(bind=bind)

    # gather observatory id
    observatory_record = (
        session.query(Observatory).filter(Observatory.name == OBSERVATORY["name"]).one()
    )
    observatory_id = observatory_record.id

    # gather telescope ids
    telescope_records = observatory_record.telescopes
    telescope_ids = [t.id for t in telescope_records]

    # gather instrument ids
    instrument_records: List[Instrument] = []
    for tele in telescope_records:
        instrument_records.extend(tele.instruments)
    instrument_ids = [i.id for i in instrument_records]

    # get user_group_id
    group_record = (
        session.query(Group).filter(Group.name == observatory_record.name).one()
    )
    user_group_id = group_record.id

    # delete the many_many
    session.query(group_observatory).filter(
        group_observatory.c.observatory_id == observatory_id
    ).delete()

    # delete all SSA objects related to instrument
    session.query(Observation).filter(
        Observation.instrument_id.in_(instrument_ids)
    ).delete()

    # this needs to change to telescope in the future
    session.query(Schedule).filter(Schedule.instrument_id.in_(telescope_ids)).delete()

    session.query(Footprint).filter(
        Footprint.instrument_id.in_(instrument_ids)
    ).delete()

    # delete instrument
    session.query(Instrument).filter(Instrument.id.in_(instrument_ids)).delete()

    # delete telescopes
    session.query(Telescope).filter(Telescope.id.in_(telescope_ids)).delete()

    # delete the user_group
    session.query(Group).filter(Group.id == user_group_id).delete()

    # delete the observatory
    session.query(Observatory).filter(Observatory.id == observatory_id).delete()

    session.commit()
    # fin
