"""add fermi

Revision ID: 7f001eadcb4a
Revises: 0f2036717762
Create Date: 2025-04-30 16:06:20.099908

"""

from typing import Sequence, Union
from uuid import uuid4

import numpy as np
from across.tools import EnergyBandpass, convert_to_wave
from across.tools.core import enums as tools_enums
from alembic import op
from sqlalchemy import orm, select

from across_server.core.enums.ephemeris_type import EphemerisType
from across_server.core.enums.instrument_type import InstrumentType
from migrations.db_util import ACROSSFootprintPoint, create_geography
from migrations.versions.model_snapshots.models_2025_04_28 import (
    Filter,
    Footprint,
    Group,
    Instrument,
    Observatory,
    ObservatoryEphemerisType,
    Telescope,
    TLEParameters,
)

# revision identifiers, used by Alembic.
revision: str = "7f001eadcb4a"
down_revision: Union[str, None] = "0f2036717762"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

# LAT has a FOV of 2.4 steradians
radius = 50  # degrees
thetas = np.linspace(0, -2 * np.pi, 200)
ras = radius * np.cos(thetas)
decs = radius * np.sin(thetas)
LAT_FOOTPRINT = [[{"x": ras[i], "y": decs[i]} for i in range(len((ras)))]]

LAT_ENERGY_BANDPASS = EnergyBandpass(
    min=0.02,
    max=300,
    unit=tools_enums.EnergyUnit.GeV,
)
LAT_WAVELENGTH_BANDPASS = convert_to_wave(LAT_ENERGY_BANDPASS)

GBM_ENERGY_BANDPASS = EnergyBandpass(
    min=0.008,
    max=40,
    unit=tools_enums.EnergyUnit.MeV,
)
GBM_WAVELENGTH_BANDPASS = convert_to_wave(GBM_ENERGY_BANDPASS)

OBSERVATORY = {
    "name": "Fermi Gamma-ray Space Telescope",
    "short_name": "Fermi",
    "observatory_type": "SPACE_BASED",
    "reference_url": "https://fermi.gsfc.nasa.gov",
    "is_operational": True,
    "telescopes": [
        {
            "name": "Large Area Telescope",
            "short_name": "LAT",
            "is_operational": True,
            "reference_url": "https://fermi.gsfc.nasa.gov",
            "instruments": [
                {
                    "name": "Large Area Telescope",
                    "short_name": "LAT",
                    "footprint": LAT_FOOTPRINT,
                    "is_operational": True,
                    "reference_url": "https://heasarc.gsfc.nasa.gov/docs/heasarc/missions/fermi.html",
                    "type": InstrumentType.CALORIMETER.value,
                    "filters": [
                        {
                            "name": "Fermi LAT Bandpass",
                            "min_wavelength": LAT_WAVELENGTH_BANDPASS.min,
                            "max_wavelength": LAT_WAVELENGTH_BANDPASS.max,
                            "is_operational": True,
                            "reference_url": "https://heasarc.gsfc.nasa.gov/docs/heasarc/missions/fermi.html",
                        }
                    ],
                },
            ],
        },
        {
            "name": "Gamma-ray Burst Monitor",
            "short_name": "GBM",
            "is_operational": True,
            "reference_url": "https://fermi.gsfc.nasa.gov",
            "instruments": [
                {
                    "name": "Gamma-ray Burst Monitor",
                    "short_name": "GBM",
                    "footprint": [],
                    "is_operational": True,
                    "reference_url": "https://heasarc.gsfc.nasa.gov/docs/heasarc/missions/fermi.html",
                    "type": InstrumentType.CALORIMETER.value,
                    "filters": [
                        {
                            "name": "Fermi GBM Bandpass",
                            "min_wavelength": GBM_WAVELENGTH_BANDPASS.min,
                            "max_wavelength": GBM_WAVELENGTH_BANDPASS.max,
                            "is_operational": True,
                            "reference_url": "https://heasarc.gsfc.nasa.gov/docs/heasarc/missions/fermi.html",
                        }
                    ],
                }
            ],
        },
    ],
}


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
    session = orm.Session(bind=bind, expire_on_commit=False)

    # create group based off the observatory
    group = Group(
        id=uuid4(), name=OBSERVATORY["name"], short_name=OBSERVATORY["short_name"]
    )
    session.add(group)

    # # create observatory
    observatory_insert = Observatory(
        id=uuid4(),
        name=OBSERVATORY["name"],
        short_name=OBSERVATORY["short_name"],
        type=OBSERVATORY["observatory_type"],
        reference_url=OBSERVATORY["reference_url"],
        is_operational=OBSERVATORY["is_operational"],
        group=group,
    )
    session.add(observatory_insert)
    observatory_id = observatory_insert.id

    # get the telescopes
    telescopes = OBSERVATORY["telescopes"]
    for telescope in telescopes:  #  type:ignore
        # create the telescope record
        telescope_insert = Telescope(
            id=uuid4(),
            name=telescope["name"],
            short_name=telescope["short_name"],
            reference_url=telescope["reference_url"],
            is_operational=telescope["is_operational"],
            observatory_id=observatory_id,
        )
        session.add(telescope_insert)
        telescope_id = telescope_insert.id

        # get the instruments
        instruments = telescope["instruments"]  #  type:ignore
        for instrument in instruments:
            # create the instrument record
            instrument_insert = Instrument(
                id=uuid4(),
                name=instrument["name"],
                short_name=instrument["short_name"],
                type=instrument["type"],
                reference_url=instrument["reference_url"],
                is_operational=instrument["is_operational"],
                telescope_id=telescope_id,
            )
            session.add(instrument_insert)
            instrument_id = instrument_insert.id

            footprints = instrument["footprint"]
            for footprint in footprints:
                # convert the input footprint to the string polygon
                vertices = []
                for point in footprint:
                    vertices.append(ACROSSFootprintPoint(x=point["x"], y=point["y"]))

                polygon = create_geography(polygon=vertices)

                # create the footprint model record
                footprint_insert = Footprint(
                    polygon=polygon, instrument_id=instrument_id
                )
                session.add(footprint_insert)

            filters = instrument["filters"]
            for filter in filters:
                filter_insert = Filter(**filter)
                filter_insert.instrument_id = instrument_id
                session.add(filter_insert)

    # Add TLEParameters for IXPE
    ephemeris_type = ObservatoryEphemerisType(
        observatory_id=observatory_id,
        ephemeris_type=EphemerisType.TLE,
        priority=1,
    )

    session.add(ephemeris_type)

    tle_parameters = TLEParameters(
        observatory_id=observatory_id,
        norad_id=33053,
        norad_satellite_name="FGRST",
    )
    session.add(tle_parameters)

    session.commit()
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
    session = orm.Session(bind=bind)

    group = session.scalar(select(Group).filter_by(name=OBSERVATORY["name"]))
    observatory = session.scalar(
        select(Observatory).filter_by(name=OBSERVATORY["name"])
    )
    observatory_id = observatory.id  # type: ignore
    tle_parameters = session.scalar(
        select(TLEParameters).filter_by(observatory_id=observatory_id)
    )

    session.delete(group)
    session.delete(observatory)
    session.delete(tle_parameters)

    session.commit()
    # ### end Alembic commands ###
